#!/usr/bin/env nix-shell
#!nix-shell -I nixpkgs=https://github.com/NixOS/nixpkgs/archive/f366af7a1b3891d9370091ab03150d3a6ee138fa.tar.gz -i zsh ./shell.nix

set -e
set -u
set -o pipefail

dir=$(dirname $0)
year=$(basename $dir)

optimize=false
while [[ $1 =~ ^- ]]; do
  case $1 in
    -O)
      optimize=true
      shift
      ;;
  esac
done

day=$(printf '%02d' $1)
shift
if [[ $# -gt 0 ]]; then
  exercise=${1:-}
  shift
fi

output_directory=("${PWD}/build/${year}")
if (( ${+exercise} )); then
  name="AOC_${day}_${exercise}"
else
  name="AOC_${day}"
fi

haskell_args=('-Wall')
if $optimize; then
  file="${dir}/${name}.hs"
  output_directory="${output_directory}/${name}"
  executable="${output_directory}/run"
  (
    ormolu -i $file
    hlint $file || :
    ghc \
      $haskell_args \
      -O2 \
      -o $executable \
      -odir $output_directory \
      -hidir $output_directory \
      $file
    echo
  )>&2
  time $executable $@
else
  (
    cd $dir
    time runhaskell $haskell_args "${name}.hs"
  )
fi
